{% extends "layout.html" %}

{% block title %}Chi ti·∫øt b√†i l√†m{% endblock %}

{% block extra_css %}
<style>
    .score-box {
        background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(33, 147, 176, 0.3);
    }
    
    .score-box h2 {
        color: white;
        font-size: 56px;
        margin-bottom: 10px;
    }
    
    .score-box h2::after {
        display: none;
    }
    
    .score-box p {
        font-size: 18px;
        opacity: 0.95;
        margin: 0;
    }
    
    .grading-status {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #2196f3;
    }
    
    .grading-status.teacher-adjusted {
        border-left-color: #4caf50;
        background: #e8f5e9;
    }
    
    .status-badge {
        display: inline-block;
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        margin-left: 10px;
    }
    
    .status-ai {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .status-teacher {
        background: #e8f5e9;
        color: #388e3c;
    }
    
    .info-box {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        border-left: 4px solid #2193b0;
    }
    
    .info-box p {
        margin: 10px 0;
        color: #2c3e50;
        font-size: 15px;
    }
    
    /* AI FEEDBACK CHO TR·∫ÆC NGHI·ªÜM */
    .ai-mc-feedback {
        background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
        padding: 25px;
        border-radius: 12px;
        margin: 30px 0;
        border: 3px solid #ffc107;
    }
    
    .ai-tf-feedback {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        padding: 25px;
        border-radius: 12px;
        margin: 30px 0;
        border: 3px solid #2193b0;
    }
    
    .ai-feedback-box {
        background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        padding: 25px;
        border-radius: 12px;
        margin: 30px 0;
        border: 3px solid #2196F3;
    }
    
    .ai-feedback-box h3,
    .ai-mc-feedback h3,
    .ai-tf-feedback h3 {
        text-align: center;
        margin-bottom: 25px;
        font-size: 24px;
        margin-top: 0;
    }
    
    .ai-mc-feedback h3 {
        color: #f57c00;
    }
    
    .ai-tf-feedback h3 {
        color: #1976d2;
    }
    
    .ai-feedback-box h3 {
        color: #1976d2;
    }
    
    .feedback-item {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin: 15px 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .feedback-label {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 10px;
        display: block;
    }
    
    .feedback-content {
        color: #333;
        line-height: 1.8;
        font-size: 15px;
        white-space: pre-wrap;
    }
    
    /* FORM ƒêI·ªÄU CH·ªàNH ƒêI·ªÇM */
    .teacher-adjust-form {
        background: #fff3e0;
        padding: 25px;
        border-radius: 12px;
        margin: 30px 0;
        border: 3px solid #f57c00;
    }
    
    .teacher-adjust-form h3 {
        color: #f57c00;
        text-align: center;
        margin-bottom: 20px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
    }
    
    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 15px;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #f57c00;
    }
    
    .btn-adjust {
        background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        box-shadow: 0 4px 15px rgba(245, 124, 0, 0.4);
    }
    
    .btn-adjust:hover {
        background: linear-gradient(135deg, #e65100 0%, #f57c00 100%);
        box-shadow: 0 6px 20px rgba(245, 124, 0, 0.6);
    }
    
    .teacher-comment-box {
        background: #e8f5e9;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #4caf50;
    }
    
    .teacher-comment-box h4 {
        color: #388e3c;
        margin-top: 0;
    }
    
    .question-block {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 25px;
        border-left: 5px solid #2193b0;
        transition: all 0.3s ease;
    }
    
    .question-block:hover {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .question-block.correct {
        border-left-color: #28a745;
        background: #d4edda;
    }
    
    .question-block.wrong {
        border-left-color: #dc3545;
        background: #f8d7da;
    }
    
    .question-block.partial {
        border-left-color: #ffc107;
        background: #fff3cd;
    }
    
    .question-title {
        font-size: 17px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #2c3e50;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
    }
    
    .option {
        padding: 12px 15px;
        margin: 10px 0;
        border-radius: 6px;
        background: white;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .option.selected {
        background: #e3f2fd;
        border-color: #2196F3;
    }
    
    .option.correct-answer {
        background: #c8e6c9;
        border-color: #4caf50;
        font-weight: 600;
    }
    
    .option.wrong-answer {
        background: #ffcdd2;
        border-color: #f44336;
    }
    
    .statement {
        padding: 12px 15px;
        margin: 10px 0;
        border-radius: 6px;
        background: white;
        border: 2px solid #e0e0e0;
    }
    
    .statement.correct {
        background: #c8e6c9;
        border-color: #4caf50;
    }
    
    .statement.wrong {
        background: #ffcdd2;
        border-color: #f44336;
    }
    
    .statement small {
        display: block;
        margin-top: 5px;
        color: #555;
    }
    
    .result-badge {
        display: inline-block;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        margin-left: 10px;
    }
    
    .result-badge.correct {
        background: #28a745;
        color: white;
    }
    
    .result-badge.wrong {
        background: #dc3545;
        color: white;
    }
    
    .result-badge.partial {
        background: #ffc107;
        color: #333;
    }
    
    .action-buttons {
        text-align: center;
        margin-top: 40px;
        padding-top: 30px;
        border-top: 2px solid #e9ecef;
    }
    
    .btn {
        display: inline-block;
        padding: 12px 30px;
        background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
        color: white;
        text-decoration: none;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
        margin: 5px;
        box-shadow: 0 4px 15px rgba(33, 147, 176, 0.4);
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(33, 147, 176, 0.6);
        color: white;
        text-decoration: none;
    }
    
    .btn-secondary {
        background: #6c757d;
        box-shadow: 0 4px 15px rgba(108, 117, 125, 0.4);
    }
    
    .btn-secondary:hover {
        background: #5a6268;
        box-shadow: 0 6px 20px rgba(108, 117, 125, 0.6);
    }
    
    .section-title {
        color: #2193b0;
        font-size: 22px;
        font-weight: 600;
        margin: 30px 0 20px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .essay-image {
        max-width: 100%;
        margin-top: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .essay-feedback-box {
        background: #f0f8ff;
        padding: 20px;
        border-radius: 8px;
        margin-top: 15px;
        border-left: 4px solid #2196F3;
    }
    
    @media print {
        .action-buttons, .teacher-adjust-form {
            display: none;
        }
        body {
            background: white;
        }
    }
</style>
{% endblock %}

{% block content %}
<h2>{{ exam.title }}</h2>

<!-- HI·ªÇN TH·ªä ƒêI·ªÇM V√Ä TR·∫†NG TH√ÅI -->
<div class="score-box">
    <h2>{{ submission.score if submission.score is not none else '...' }}/10</h2>
    <p>
        {{ 'Diem cua ban' if session.exam_role == 'student' else 'Diem cua hoc sinh' }}
        {% if submission.teacher_adjusted %}
            <span class="status-badge status-teacher">‚úì Gi√°o vi√™n ƒë√£ ƒëi·ªÅu ch·ªânh</span>
        {% elif submission.ai_graded %}
            <span class="status-badge status-ai">ü§ñ AI ƒë√£ ch·∫•m</span>
        {% endif %}
    </p>
</div>

<!-- TR·∫†NG TH√ÅI CH·∫§M ƒêI·ªÇM -->
{% if submission.teacher_adjusted %}
<div class="grading-status teacher-adjusted">
    <h4 style="color: #388e3c; margin-top: 0;">‚úì Gi√°o vi√™n ƒë√£ ƒëi·ªÅu ch·ªânh ƒëi·ªÉm</h4>
    <p><strong>ƒêi·ªÉm AI g·ªëc:</strong> {{ submission.get('original_ai_score', submission.score) }}/10</p>
    <p><strong>ƒêi·ªÉm sau ƒëi·ªÅu ch·ªânh:</strong> {{ submission.score }}/10</p>
</div>
{% elif submission.ai_graded %}
<div class="grading-status">
    <h4 style="color: #1976d2; margin-top: 0;">ü§ñ B√†i ƒë√£ ƒë∆∞·ª£c AI t·ª± ƒë·ªông ch·∫•m</h4>
    <p>AI ƒë√£ ph√¢n t√≠ch v√† ch·∫•m ƒëi·ªÉm ngay sau khi b·∫°n n·ªôp b√†i.</p>
    {% if session.exam_role == 'teacher' %}
        <p style="color: #f57c00;"><strong>L∆∞u √Ω:</strong> B·∫°n c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh ƒëi·ªÉm b√™n d∆∞·ªõi n·∫øu c·∫ßn.</p>
    {% endif %}
</div>
{% endif %}

<div class="info-box">
    <p><strong>H·ªçc sinh:</strong> {{ submission.student }}</p>
    <p><strong>Ng√†y n·ªôp:</strong> {{ submission.submitted_at }}</p>
    <p><strong>Lo·∫°i ƒë·ªÅ:</strong> 
        {% if submission.type == 'multiple_choice' %}Tr·∫Øc nghi·ªám
        {% elif submission.type == 'mixed' %}H·ªón h·ª£p
        {% else %}T·ª± lu·∫≠n{% endif %}
    </p>
    <p><strong>L·ªõp:</strong> {{ exam.grade }}</p>
</div>

<!-- AI FEEDBACK CHO C√ÇU TR·∫ÆC NGHI·ªÜM SAI -->
{% if submission.mc_ai_feedback %}
<div class="ai-mc-feedback">
    <h3>AI PH√ÇN T√çCH C√ÅC C√ÇU TR·∫ÆC NGHI·ªÜM SAI</h3>
    
    <div class="feedback-item">
        <span class="feedback-label" style="color: #f57c00;">üìö K·∫ø ho·∫°ch √¥n t·∫≠p:</span>
        <div class="feedback-content">{{ submission.mc_ai_feedback.ke_hoach_on_tap }}</div>
    </div>
    
    <div class="feedback-item">
        <span class="feedback-label" style="color: #2193b0;">üîóC√°c ch·ªß ƒë·ªÅ li√™n quan:</span>
        <div class="feedback-content">{{ submission.mc_ai_feedback.cac_chu_de_lien_quan }}</div>
    </div>
</div>
{% endif %}

<!-- AI FEEDBACK CHO C√ÇU ƒê√öNG/SAI SAI -->
{% if submission.tf_ai_feedback %}
<div class="ai-tf-feedback">
    <h3>AI PH√ÇN T√çCH ƒê√öNG/SAI</h3>
    
    <div class="feedback-item">
        <span class="feedback-label" style="color: #f57c00;">üìö K·∫ø ho·∫°ch √¥n t·∫≠p:</span>
        <div class="feedback-content">{{ submission.tf_ai_feedback.ke_hoach_on_tap }}</div>
    </div>
    
    <div class="feedback-item">
        <span class="feedback-label" style="color: #2193b0;">üîó C√°c ch·ªß ƒë·ªÅ li√™n quan:</span>
        <div class="feedback-content">{{ submission.tf_ai_feedback.cac_chu_de_lien_quan }}</div>
    </div>
</div>
{% endif %}

<!-- PHAN HOI AI CHO BAI TU LUAN -->
{% if submission.ai_feedback %}
<div class="ai-feedback-box">
    <h3>PH√ÇN T√çCH T·ª™ AI</h3>
    
    <div class="feedback-item">
        <span class="feedback-label" style="color: #28a745;">‚úÖ ƒêi·ªÉm m·∫°nh:</span>
        <div class="feedback-content">{{ submission.ai_feedback.strengths }}</div>
    </div>
    
    <div class="feedback-item">
        <span class="feedback-label" style="color: #dc3545;">‚ö†Ô∏è ƒêi·ªÉm y·∫øu c·∫ßn c·∫£i thi·ªán:</span>
        <div class="feedback-content">{{ submission.ai_feedback.weaknesses }}</div>
    </div>
    
    <div class="feedback-item">
        <span class="feedback-label" style="color: #ffc107;">üìö Ki·∫øn th·ª©c c√≤n thi·∫øu:</span>
        <div class="feedback-content">{{ submission.ai_feedback.missing_knowledge }}</div>
    </div>
    
    <div class="feedback-item">
        <span class="feedback-label" style="color: #17a2b8;">üìù D·∫°ng b√†i c·∫ßn luy·ªán t·∫≠p:</span>
        <div class="feedback-content">{{ submission.ai_feedback.improvement_areas }}</div>
    </div>
    
    <div class="feedback-item">
        <span class="feedback-label" style="color: #2193b0;">üí° L·ªùi khuy√™n:</span>
        <div class="feedback-content">{{ submission.ai_feedback.suggestions }}</div>
    </div>
</div>
{% endif %}

<!-- NH·∫¨N X√âT C·ª¶A GI√ÅO VI√äN (n·∫øu c√≥) -->
{% if submission.teacher_comment %}
<div class="teacher-comment-box">
    <h4>üë®‚Äçüè´ Nh·∫≠n x√©t c·ªßa gi√°o vi√™n</h4>
    <p style="line-height: 1.8; white-space: pre-wrap;">{{ submission.teacher_comment }}</p>
</div>
{% endif %}

<!-- FORM ƒêI·ªÄU CH·ªàNH ƒêI·ªÇM (CH·ªà HI·ªÜN CHO GI√ÅO VI√äN) -->
{% if session.exam_role == 'teacher' %}
<div class="teacher-adjust-form">
    <h3>üë®‚Äçüè´ ƒêi·ªÅu ch·ªânh ƒëi·ªÉm (Gi√°o vi√™n)</h3>
    <p style="text-align: center; color: #666; margin-bottom: 20px;">
        {% if submission.teacher_adjusted %}
            B·∫°n ƒë√£ ƒëi·ªÅu ch·ªânh ƒëi·ªÉm cho b√†i n√†y. B·∫°n c√≥ th·ªÉ thay ƒë·ªïi l·∫°i n·∫øu c·∫ßn.
        {% else %}
            AI ƒë√£ ch·∫•m ƒëi·ªÉm: <strong>{{ submission.score }}/10</strong>. B·∫°n c√≥ th·ªÉ gi·ªØ nguy√™n ho·∫∑c ƒëi·ªÅu ch·ªânh.
        {% endif %}
    </p>
    
    <form method="POST" action="{{ url_for('adjust_score', submission_index=submission_index) }}">
        <div class="form-group">
            <label>ƒêi·ªÉm m·ªõi (0-10):</label>
            <input type="number" 
                   name="teacher_score" 
                   min="0" 
                   max="10" 
                   step="0.1" 
                   value="{{ submission.teacher_score if submission.teacher_adjusted else submission.score }}"
                   required>
            <small style="color: #666;">ƒêi·ªÉm AI: {{ submission.score }}/10</small>
        </div>
        
        <div class="form-group">
            <label>Nh·∫≠n x√©t c·ªßa gi√°o vi√™n (T√πy ch·ªçn):</label>
            <textarea name="teacher_comment" 
                      rows="6" 
                      placeholder="Th√™m nh·∫≠n x√©t, g√≥p √Ω cho h·ªçc sinh...">{{ submission.teacher_comment if submission.teacher_comment else '' }}</textarea>
        </div>
        
        <button type="submit" class="btn-adjust">
            {% if submission.teacher_adjusted %}
                C·∫≠p nh·∫≠t ƒëi·ªÅu ch·ªânh
            {% else %}
                X√°c nh·∫≠n ƒëi·ªÅu ch·ªânh ƒëi·ªÉm
            {% endif %}
        </button>
    </form>
</div>
{% endif %}

<!-- DE TRAC NGHIEM HOAC HON HOP -->
{% if submission.type == 'multiple_choice' or submission.type == 'mixed' %}
    <h3 class="section-title">Cau tra loi chi tiet</h3>
    
    <!-- Phan trac nghiem ABCD -->
    {% if exam.questions.multiple_choice %}
    <h4 style="color: #2c3e50; margin: 25px 0 15px 0;">Phan 1: Trac nghiem ABCD ({{ '60' if submission.type == 'multiple_choice' else '40' }}%)</h4>
    {% for i in range(exam.questions.multiple_choice|length) %}
        {% set question = exam.questions.multiple_choice[i] %}
        {% set user_answer = submission.answers.get('mc_' ~ i) %}
        {% set is_correct = (user_answer == question.answer) %}
        
        <div class="question-block {{ 'correct' if is_correct else 'wrong' }}">
            <div class="question-title">
                <span>Cau {{ i + 1 }}: {{ question.question }}</span>
                <span class="result-badge {{ 'correct' if is_correct else 'wrong' }}">
                    {{ 'Dung ‚úì' if is_correct else 'Sai ‚úó' }}
                </span>
            </div>
            
            {% for option in question.options %}
                {% set option_letter = option.split('.')[0] %}
                {% set is_selected = (user_answer == option_letter) %}
                {% set is_correct_option = (option_letter == question.answer) %}
                
                <div class="option 
                    {% if is_selected and is_correct_option %}selected correct-answer
                    {% elif is_selected %}selected wrong-answer
                    {% elif is_correct_option %}correct-answer
                    {% endif %}">
                    {{ option }}
                    {% if is_selected %}
                        <strong style="color: #2196F3;"> ‚Üê B·∫°n ch·ªçn</strong>
                    {% endif %}
                    {% if is_correct_option and not is_selected %}
                        <strong style="color: #4caf50;"> ‚Üê ƒê√°p √°n ƒë√∫ng</strong>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% endfor %}
    {% endif %}
    
    <!-- Phan dung sai -->
    {% if exam.questions.true_false %}
    <h4 style="color: #2c3e50; margin: 35px 0 15px 0;">Phan 2: Dung/Sai ({{ '40' if submission.type == 'multiple_choice' else '30' }}%)</h4>
    <p style="color: #666; margin-bottom: 20px;">
        Phuong phap cham: 
        {% if exam.get('tf_grading_method') == 'per_item' %}
            Moi y dung +0.25d
        {% else %}
            Sai 1y (-0.5d), Sai 2y (-0.75d), Sai 3y (con 0.1d)
        {% endif %}
    </p>
    
    {% for i in range(exam.questions.true_false|length) %}
        {% set tf_question = exam.questions.true_false[i] %}
        {% set user_answers = submission.answers.get('tf_' ~ i, []) %}
        {% set wrong_count = 0 %}
        {% for j in range(4) %}
            {% if j < user_answers|length and user_answers[j] != tf_question.answers[j] %}
                {% set wrong_count = wrong_count + 1 %}
            {% endif %}
        {% endfor %}
        
        {% if wrong_count == 0 %}
            {% set status = 'correct' %}
            {% set label = 'Hoan toan dung ‚úì' %}
        {% elif wrong_count == 1 %}
            {% set status = 'partial' %}
            {% set label = 'Sai 1/4 y' %}
        {% elif wrong_count == 2 %}
            {% set status = 'partial' %}
            {% set label = 'Sai 2/4 y' %}
        {% elif wrong_count == 3 %}
            {% set status = 'partial' %}
            {% set label = 'Sai 3/4 y' %}
        {% else %}
            {% set status = 'wrong' %}
            {% set label = 'Hoan toan sai ‚úó' %}
        {% endif %}
        
        <div class="question-block {{ status }}">
            <div class="question-title">
                <span>Cau {{ i + 1 + exam.questions.multiple_choice|length }}: {{ tf_question.question }}</span>
                <span class="result-badge {{ status }}">{{ label }}</span>
            </div>
            
            {% for j in range(tf_question.statements|length) %}
                {% set statement = tf_question.statements[j] %}
                {% set user_tf = user_answers[j] if j < user_answers|length else false %}
                {% set correct_tf = tf_question.answers[j] %}
                {% set is_correct = (user_tf == correct_tf) %}
                
                <div class="statement {{ 'correct' if is_correct else 'wrong' }}">
                    <strong>{{ j + 1 }}.</strong> {{ statement }}
                    <small>
                        <strong>Ban chon:</strong> {{ 'Dung' if user_tf else 'Sai' }} | 
                        <strong>Dap an:</strong> {{ 'Dung' if correct_tf else 'Sai' }}
                        <strong>{{ '‚úì' if is_correct else '‚úó' }}</strong>
                    </small>
                </div>
            {% endfor %}
        </div>
    {% endfor %}
    {% endif %}
    
    <!-- PHAN TU LUAN (n·∫øu c√≥ trong b√†i h·ªón h·ª£p) -->
    {% if submission.type == 'mixed' and exam.questions.essay %}
    <h4 style="color: #2c3e50; margin: 35px 0 15px 0;">Ph·∫ßn 3: T·ª± lu·∫≠n (30%)</h4>
    
    {% for i in range(exam.questions.essay|length) %}
        {% set essay_q = exam.questions.essay[i] %}
        {% set essay_answer = submission.answers.essay[i] if submission.answers.essay else {} %}
        
        <div class="question-block">
            <div class="question-title">
                <span>C√¢u {{ i + 1 + exam.questions.multiple_choice|length + exam.questions.true_false|length }}: {{ essay_q.question }}</span>
            </div>
            
            <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 15px;">
                <strong style="color: #2193b0;">C√¢u tr·∫£ l·ªùi c·ªßa h·ªçc sinh:</strong>
                <p style="margin-top: 10px; line-height: 1.8; white-space: pre-wrap;">{{ essay_answer.text if essay_answer.text else 'Kh√¥ng c√≥ c√¢u tr·∫£ l·ªùi' }}</p>
                
                {% if essay_answer.image_path %}
                <div style="margin-top: 15px;">
                    <strong style="color: #2193b0;">H√¨nh ·∫£nh ƒë√≠nh k√®m:</strong>
                    <br>
                    <img src="{{ url_for('static', filename=essay_answer.image_path.replace('static/', '')) }}" 
                         alt="B√†i l√†m" 
                         class="essay-image">
                </div>
                {% endif %}
            </div>
            
            {% if submission.essay_ai_feedback and submission.essay_ai_feedback[i] %}
            <div class="essay-feedback-box">
                <h4 style="color: #2196F3; margin-top: 0;">ü§ñ Nh·∫≠n x√©t AI cho c√¢u n√†y</h4>
                <p><strong>ƒêi·ªÉm:</strong> {{ submission.essay_ai_feedback[i].score }}/10</p>
                <p style="line-height: 1.8; margin-top: 10px;">{{ submission.essay_ai_feedback[i].feedback }}</p>
            </div>
            {% endif %}
        </div>
    {% endfor %}
    {% endif %}
{% endif %}

<!-- DE TU LUAN THU·∫¶N -->
{% if submission.type == 'essay' %}
    <h3 class="section-title">B√†i l√†m t·ª± lu·∫≠n</h3>
    
    <div class="question-block">
        <div class="question-title">
            <span>{{ exam['questions']['essay'][0]['question'] }}</span>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 15px;">
            <strong style="color: #2193b0;">C√¢u tr·∫£ l·ªùi:</strong>
            <p style="margin-top: 10px; line-height: 1.8; white-space: pre-wrap;">{{ submission.essay_answer }}</p>
            
            {% if submission.image_path %}
            <div style="margin-top: 15px;">
                <strong style="color: #2193b0;">H√¨nh ·∫£nh ƒë√≠nh k√®m:</strong>
                <br>
                <img src="{{ url_for('static', filename=submission.image_path.replace('static/', '')) }}" 
                     alt="B√†i l√†m" 
                     class="essay-image">
            </div>
            {% endif %}
        </div>
    </div>
{% endif %}

<!-- BUTTONS -->
<div class="action-buttons">
    {% if session.exam_role == 'teacher' %}
        <a href="{{ url_for('dashboard_teacher') }}" class="btn">‚Üê Quay l·∫°i Dashboard</a>
    {% else %}
        <a href="{{ url_for('dashboard_student') }}" class="btn">‚Üê Quay l·∫°i Dashboard</a>
    {% endif %}
    <button onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è In b√†i l√†m</button>
</div>

{% endblock %}